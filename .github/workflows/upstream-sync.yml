name: Upstream Sync
on:
  schedule:
    - cron:  '0 20 * * *'  # ë§¤ì¼ í•œêµ­ì‹œê°„ ì˜¤ì „ 5ì‹œ
  workflow_dispatch:

jobs:
  sync:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0
          token: ${{ secrets.GH_PAT }}
          
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'yarn'
          
      - name: Install dependencies
        run: yarn install --frozen-lockfile
        
      - name: Add upstream
        run: |
          git remote add upstream https://github.com/temporalio/documentation.git
          git fetch upstream
          
      # ì—…ìŠ¤íŠ¸ë¦¼ ë³€ê²½ì‚¬í•­ í™•ì¸
      - name: Check upstream changes
        id: check-changes
        run: |
          UPSTREAM_COMMIT=$(git rev-parse upstream/main)
          CURRENT_COMMIT=$(git rev-parse HEAD)
          echo "upstream_commit=$UPSTREAM_COMMIT" >> $GITHUB_OUTPUT
          echo "current_commit=$CURRENT_COMMIT" >> $GITHUB_OUTPUT
          
          if [ "$UPSTREAM_COMMIT" != "$CURRENT_COMMIT" ]; then
            echo "has_changes=true" >> $GITHUB_OUTPUT
            echo "ì—…ìŠ¤íŠ¸ë¦¼ì— ìƒˆë¡œìš´ ë³€ê²½ì‚¬í•­ì´ ìˆìŠµë‹ˆë‹¤"
          else
            echo "has_changes=false" >> $GITHUB_OUTPUT
            echo "ë³€ê²½ì‚¬í•­ì´ ì—†ìŠµë‹ˆë‹¤"
          fi
          
      # ë³€ê²½ì‚¬í•­ì´ ìˆì„ ë•Œë§Œ ë™ê¸°í™” ì‹¤í–‰
      - name: Reset to upstream/main
        if: steps.check-changes.outputs.has_changes == 'true'
        run: |
          git checkout -B upstream-sync upstream/main
          
      # ìƒˆ ì˜ì–´ ë¬¸ìì—´ì„ ko ë²ˆì—­ íì— ë°˜ì˜
      - name: Write empty translations
        if: steps.check-changes.outputs.has_changes == 'true'
        run: |
          # ê¸°ì¡´ ë²ˆì—­ íŒŒì¼ë“¤ ë°±ì—…
          echo "ê¸°ì¡´ ë²ˆì—­ íŒŒì¼ ë°±ì—… ì¤‘..."
          if [ -f "i18n/ko/code.json" ]; then
            cp i18n/ko/code.json i18n/ko/code.json.backup
          fi
          if [ -f "i18n/ko/docusaurus-theme-classic/navbar.json" ]; then
            cp i18n/ko/docusaurus-theme-classic/navbar.json i18n/ko/docusaurus-theme-classic/navbar.json.backup
          fi
          
          # ìƒˆ ë²ˆì—­ íŒŒì¼ ìƒì„±
          yarn docusaurus write-translations --locale ko
          
          # ì»¤ìŠ¤í…€ ë²ˆì—­ ë³µì› (Node.jsë¥¼ ì‚¬ìš©í•˜ì—¬ JSON ë³‘í•©)
          echo "ì»¤ìŠ¤í…€ ë²ˆì—­ ë³µì› ì¤‘..."
          if [ -f "i18n/ko/code.json.backup" ]; then
            node -e "
              const fs = require('fs');
              const backup = JSON.parse(fs.readFileSync('i18n/ko/code.json.backup', 'utf8'));
              const generated = JSON.parse(fs.readFileSync('i18n/ko/code.json', 'utf8'));
              
              // intro.* ê´€ë ¨ ì»¤ìŠ¤í…€ ë²ˆì—­ ë³µì›
              Object.keys(backup).forEach(key => {
                if (key.startsWith('intro.') && backup[key].message) {
                  generated[key] = backup[key];
                }
              });
              
              fs.writeFileSync('i18n/ko/code.json', JSON.stringify(generated, null, 2));
              console.log('code.json ì»¤ìŠ¤í…€ ë²ˆì—­ ë³µì› ì™„ë£Œ');
            "
          fi
          
          if [ -f "i18n/ko/docusaurus-theme-classic/navbar.json.backup" ]; then
            node -e "
              const fs = require('fs');
              const backup = JSON.parse(fs.readFileSync('i18n/ko/docusaurus-theme-classic/navbar.json.backup', 'utf8'));
              const generated = JSON.parse(fs.readFileSync('i18n/ko/docusaurus-theme-classic/navbar.json', 'utf8'));
              
              // ì»¤ìŠ¤í…€ ë²ˆì—­ ë³µì›
              Object.keys(backup).forEach(key => {
                if (backup[key].message && backup[key].message !== generated[key]?.message) {
                  generated[key] = backup[key];
                }
              });
              
              fs.writeFileSync('i18n/ko/docusaurus-theme-classic/navbar.json', JSON.stringify(generated, null, 2));
              console.log('navbar.json ì»¤ìŠ¤í…€ ë²ˆì—­ ë³µì› ì™„ë£Œ');
            "
          fi
          
          # ë°±ì—… íŒŒì¼ ì •ë¦¬
          rm -f i18n/ko/code.json.backup
          rm -f i18n/ko/docusaurus-theme-classic/navbar.json.backup
          
          # blog ë²ˆì—­ íŒŒì¼ ì œê±°
          rm -rf i18n/ko/docusaurus-plugin-content-blog
          
      # ë²ˆì—­ íŒŒì¼ ìƒíƒœ í™•ì¸
      - name: Check translation changes
        if: steps.check-changes.outputs.has_changes == 'true'
        id: check-translations
        run: |
          if [ -n "$(git status --porcelain)" ]; then
            echo "translation_changes=true" >> $GITHUB_OUTPUT
            echo "ë²ˆì—­ íŒŒì¼ ë³€ê²½ì‚¬í•­:"
            git status --porcelain
          else
            echo "translation_changes=false" >> $GITHUB_OUTPUT
            echo "ë²ˆì—­ íŒŒì¼ ë³€ê²½ì‚¬í•­ ì—†ìŒ"
          fi

      # ë³€ê²½ ì‚¬í•­ ì»¤ë°‹
      - name: Commit changes
        if: steps.check-changes.outputs.has_changes == 'true' && steps.check-translations.outputs.translation_changes == 'true'
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add -A
          
          # ì»¤ë°‹ ë©”ì‹œì§€ì— ë” ìì„¸í•œ ì •ë³´ í¬í•¨
          COMMIT_MSG="chore: ğŸ”„ ì—…ìŠ¤íŠ¸ë¦¼ ë™ê¸°í™” $(date -u +'%Y-%m-%d')

          ì—…ìŠ¤íŠ¸ë¦¼ ì»¤ë°‹: ${{ steps.check-changes.outputs.upstream_commit }}
          ì´ì „ ì»¤ë°‹: ${{ steps.check-changes.outputs.current_commit }}
          
          ìë™ ìƒì„±ëœ ë²ˆì—­ í‚¤:
          $(git diff --cached --name-only | grep -E '\.(json|md)$' | head -10)
          "
          
          git commit -m "$COMMIT_MSG"

      # ë¸Œëœì¹˜ í‘¸ì‹œ
      - name: Push branch
        if: steps.check-changes.outputs.has_changes == 'true' && steps.check-translations.outputs.translation_changes == 'true'
        run: |
          git push -f origin upstream-sync

      # ìë™ PR ìƒì„±
      - name: Create Pull Request
        if: steps.check-changes.outputs.has_changes == 'true' && steps.check-translations.outputs.translation_changes == 'true'
        uses: peter-evans/create-pull-request@v6
        with:
          token: ${{ secrets.GH_PAT }}
          base: main
          branch: upstream-sync
          title: "chore: ğŸ”„ ì—…ìŠ¤íŠ¸ë¦¼ ë™ê¸°í™” ($(date -u +'%Y-%m-%d'))"
          body: |
            ## ğŸ“‹ ìë™ ì—…ìŠ¤íŠ¸ë¦¼ ë™ê¸°í™”
            
            **ì—…ìŠ¤íŠ¸ë¦¼ ì»¤ë°‹**: `${{ steps.check-changes.outputs.upstream_commit }}`
            **ì´ì „ ì»¤ë°‹**: `${{ steps.check-changes.outputs.current_commit }}`
            
            ### ğŸ”„ ë³€ê²½ì‚¬í•­
            - ì—…ìŠ¤íŠ¸ë¦¼ ìµœì‹  ë³€ê²½ì‚¬í•­ ë°˜ì˜
            - ìƒˆë¡œìš´ ë²ˆì—­ í‚¤ ìë™ ìƒì„±
            - ì‚¬ìš©í•˜ì§€ ì•ŠëŠ” ë²ˆì—­ í‚¤ ì œê±°
            
            ### âœ… ë‹¤ìŒ ë‹¨ê³„
            1. ìƒˆë¡œ ì¶”ê°€ëœ ì˜ì–´ ë¬¸ìì—´ í™•ì¸
            2. ë²ˆì—­ ì‘ì—… ì§„í–‰
            3. ë¦¬ë·° í›„ ë¨¸ì§€
            
            ---
            *ì´ PRì€ ìë™ìœ¼ë¡œ ìƒì„±ë˜ì—ˆìŠµë‹ˆë‹¤.*
          labels: |
            sync
            automated-pr
            translation
          draft: false
          
      # ë³€ê²½ì‚¬í•­ ì—†ìŒ ì•Œë¦¼
      - name: No changes notification
        if: steps.check-changes.outputs.has_changes == 'false'
        run: |
          echo "::notice::ì—…ìŠ¤íŠ¸ë¦¼ì— ìƒˆë¡œìš´ ë³€ê²½ì‚¬í•­ì´ ì—†ìŠµë‹ˆë‹¤."
